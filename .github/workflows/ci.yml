name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    runs-on: ubuntu-22.04
    defaults:
      run:
        shell: bash
    env:
      POLYGON_EDGE_REF: v1.3.3
      EDGE_REPO_URL: https://github.com/BioMark3r/polygon-edge.git
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go from go.mod
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install build dependencies
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            git \
            make \
            ca-certificates \
            build-essential \
            file
          sudo rm -rf /var/lib/apt/lists/*

      - name: Tool versions
        run: |
          set -euo pipefail
          go version
          git --version
          make --version

      - name: Restore polygon-edge cache
        uses: actions/cache@v4
        with:
          path: |
            third_party/polygon-edge
            bin/polygon-edge
          key: ${{ runner.os }}-polygon-edge-${{ env.POLYGON_EDGE_REF }}-${{ hashFiles('**/go.sum', 'Makefile', 'scripts/**', 'config/**') }}
          restore-keys: |
            ${{ runner.os }}-polygon-edge-${{ env.POLYGON_EDGE_REF }}-

      - name: Run tests
        run: |
          set -euo pipefail
          go test ./...

      - name: Build binaries
        run: |
          set -euo pipefail
          export EDGE_REF="${POLYGON_EDGE_REF}"
          if make -n edge >/dev/null 2>&1 && make -n qikchain >/dev/null 2>&1; then
            make edge
            make qikchain
          else
            make all
          fi

      - name: Verify artifacts
        run: |
          set -euo pipefail
          test -x bin/qikchain
          test -x bin/polygon-edge
          ls -la bin/
          file bin/qikchain bin/polygon-edge

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: qikchain-linux-build
          retention-days: 7
          path: |
            bin/qikchain
            bin/polygon-edge

      - name: Failure diagnostics
        if: failure()
        run: |
          set -euo pipefail
          echo "== workspace =="
          ls -la
          echo "== bin =="
          ls -la bin/ || true
          echo "== go env =="
          go env
          echo "== recent logs =="
          find . -maxdepth 3 -type f \( -name '*.log' -o -name '*.out' \) -print -exec tail -n 200 {} \;
